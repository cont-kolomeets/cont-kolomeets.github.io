<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Infographic</title>
    <link href="https://js.arcgis.com/3.28/dijit/themes/claro/claro.css" rel="stylesheet" />
    <link href="https://js.arcgis.com/3.28/esri/css/esri.css" rel="stylesheet" />
    <style>
        html,
        body,
        #layoutNode {
            padding: 0px;
            margin: 0px;
            height: 100%;
            overflow: hidden;
            font-size: 13px;
            font-family: "Avenir Next";
        }

    </style>
    <script src="https://js.arcgis.com/3.28/"></script>
    <script>
        require(["require", "esri/dijit/geoenrichment/nlsFix"],
            function (relativeRequire, nlsFix) {
                nlsFix.load(null, relativeRequire);
                require([
                        "dojo/Deferred",

                        "esri/dijit/geoenrichment/utils/WaitingUtil",
                        "dojo/domReady!"
                    ],
                    function (
                        Deferred,
                        WaitingUtil
                    ) {
                        var dfd = new Deferred();
                        WaitingUtil.showProgressPromise(document.body, dfd.promise);

                        require([
                                "dojo/when",
                                "dojo/query",

                                "esri/dijit/geoenrichment/ReportPlayer/ReportPlayer",
                                "esri/dijit/geoenrichment/ReportPlayer/PlayerViewModes",
                                "esri/dijit/geoenrichment/utils/UrlUtil",
                                "esri/dijit/geoenrichment/utils/requests/UniversalClient",
                                "dojo/domReady!"
                            ],
                            function (
                                when,
                                dojoQuery,

                                ReportPlayer,
                                PlayerViewModes,
                                UrlUtil,
                                UniversalClient
                            ) {

                                // URL params:
                                // proxy                String. Optional.
                                // resourceUrl          String. Required.
                                // token                String. Recommended.
                                // viewMode             "panelsInSlides" | none. Default PlayerViewModes.FULL_PAGES. Optional.
                                // showToolbarInPopup   "true" | "false". Default "false". Optional.
                                // showFullScreenButton "true" | "false". Default "false". Optional.

                                function getUrlVariable(name) {
                                    return UrlUtil.getVariableValue(window.location.href, name);
                                };

                                esriConfig.defaults.io.proxyUrl = getUrlVariable("proxy") || null;

                                function getCookie(name) {
                                    var value = "; " + document.cookie;
                                    var parts = value.split("; " + name + "=");
                                    if (parts.length == 2)
                                        return parts.pop().split(";").shift();
                                };

                                try {
                                    console.log("iFrame loaded.");
                                    console.log("This document cookie:");
                                    console.log(decodeURIComponent(document.cookie || ""));
                                    if (window.top && window.top.document) {
                                        // this doesn't seem to work because of the security issue
                                        console.log("Parent document cookie:");
                                        console.log(decodeURIComponent(window.top.document.cookie || ""));
                                    }
                                } catch (e) {
                                    console.log(e);
                                }

                                // Steps:
                                // 1. Download a resource.
                                // 2. Play the data.

                                // 1.
                                // e.g., https://www.arcgis.com/sharing/rest/content/items/dedca473ada34e4a8556aa396f5aadb3/resources/thumbnail.png
                                var fullUrl = getUrlVariable("resourceUrl");
                                if (getUrlVariable("token"))
                                    fullUrl += "?token=" + getUrlVariable("token");
                                UniversalClient.request(fullUrl).then(function (result) {
                                    // 2.
                                    var player = new ReportPlayer({
                                        showToolbarInPopup: getUrlVariable("showToolbarInPopup") === "true",
                                        viewMode: getUrlVariable("viewMode") || PlayerViewModes.FULL_PAGES,
                                        onError: function (e) {
                                            console.log(e);
                                        }
                                    }).placeAt(layoutNode);
                                    // will be handled as json
                                    when(player.reportDataFromJson(result), function () {
                                        if (getUrlVariable("showFullScreenButton") === "true") {
                                            var toolbarNode = dojoQuery(".esriGEPlayerToolbar")[0];
                                            if (toolbarNode) {
                                                var customButton = document.createElement("div");
                                                customButton.innerHTML = "View full screen";
                                                customButton.classList.add("dijitInline");
                                                customButton.style.marginLeft = "25px";
                                                customButton.style.marginRight = "25px";
                                                customButton.style.cursor = "pointer";
                                                customButton.addEventListener("click", function () {
                                                    var fullScreenUrl = window.location.href;
                                                    // remove some parameters
                                                    fullScreenUrl = fullScreenUrl.replace(/viewMode=panelsInSlides/i, "") + "&showToolbarInPopup=false&showFullScreenButton=false";
                                                    window.open(fullScreenUrl, "_blank");
                                                });
                                                toolbarNode.appendChild(customButton);
                                            }
                                        }
                                    });
                                }).always(dfd.resolve);
                            });
                    });
            });

    </script>
</head>

<body class="claro" style="margin:0px;">
    <div id="layoutNode"></div>
</body>

</html>
